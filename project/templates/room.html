{% extends "base.html" %}

{% block content %}
	<script type="text/javascript">
		$(document).ready(function() {
			var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
			var room_id = "{{ room.room_id }}";
			var username = "{{ username }}";
            
            socket.on("connect", function() {
                console.log(username);
                socket.emit("join", {"room_id": room_id, "username": username});
            });

			$(window).bind("beforeunload", function() {
				socket.emit("leave", {"room_id": room_id, "username": username});
			});

            socket.on("update-room-users", function(current_users) {
                $("#room-users").empty();
                $("#room-users").append("<tr><td><b>Users:</b></td></tr>");
                console.log(current_users.length)
                for (var i = 0; i < current_users.length; i++) {
                    $("#room-users").append("<tr><td>" + current_users[i] + "</td></tr>");
                }
            });

            socket.on("update-sug-list", function(songs) {
                $("#title").empty();
                $("#title").append("<h3>Current Playlist:</h3>");
                $("#sug-list").empty();
                for (var i = 0; i < songs.length; i++) {
                    $("#sug-list").append("<li>\"" + songs[i][0] + "\" by " + songs[i][1] + "</li>");
                }
                $("#title").css("display", "inline");
                $("#sug-list").css("display", "block");
            });


			socket.on("song-query-results", function(results) {
				$("#results").empty();
                $("#results").append("<br>");
                if (results.length > 0) {
				    for (var i = 0; i < results.length; i++) {
                        $("#results").append("<input type=\"radio\" name=\"song\" value=\"" + results[i].spotify_url + "\">" + "<img src=" + results[i].album_cover + " height=\"40\" width=\"40\"/>" + results[i].name + "<br>");
				    }
				    $("#results").css("display", "block");
                    $("#submit").css("display", "inline");
                } else {
                    $("#results").append("No songs were found.");
                    $("#results").css("display", "block");
                    $("#submit").css("display", "none");
                }
			});

            socket.on("failed", function(str) {
                // Called if back-end failed to add song to room playlist.
                // TODO message about failing to add to list
                console.log(str);
                $("#results").append(str);
                $("#results").css("display", "block");
            });

            $("#search-box").keypress(function(e) {
                var code = e.keyCode || e.which;
                if (code == 13) {
                    $("#search-button").click()
                }
            });

			$("#message-box").keypress(function(e) {
				var code = e.keyCode || e.which;
				if (code == 13 && $("#message-box").val() !== "") {
					$("#send-message").click();
					$("#message-box").val('');
				}
			});

			$("#send-message").on("click", function() {
				socket.emit("chat-message", {"msg": $("#message-box").val(), "username": username, "room_id": room_id});
			});

			socket.on("chat-message", function(msg) {
				$("#messages-list").append("<li>" + msg + "</li>");
				console.log("Received message");
			});

			$("#search-button").on("click", function() {
				if ($("#search-box").val() != "") {
                    socket.emit("song-query", {"query": $("#search-box").val(), "num_selections": $("#num-selections").val()});
				}
			});
            
            $("#submit").on("click", function() {
                selected = document.forms.results.song.value
                if (selected != null) {
                    var room_id = "{{ room.room_id }}";
                    socket.emit("song-selection", {"spotify_url": selected, 
                        "room_id": room_id});
                    $("#results").empty();
                    $("#results").css("display", "none");
                    $("#submit").css("display", "none");
                    $("#search-box").val("")
                }
            });
		});
	</script>

    <style>
    table {
        border-collapse: collapse;
        border: 1px solid black;
    }
    </style>

    {% if room.room_name %}
        <h1>{{ room.room_name }} </h1>
        <p>Room code: {{ room.room_id }}</p>
    {% else %}
        <h1>Room {{ room.room_id }}</h1>
    {% endif %}
    
    <font size="18">
        <table id="room-users" align="right" width="20%" border="1">
        </table>
    </font>

    <h3 id="title" style="display:none"></h3>
    <ol id="sug-list" style="display:none"></ol>
    
 	<br>
    <h3>Suggest a Song:</h3>
	<input type="text" id="search-box">
    <select id="num-selections">
        {% for i in range(1, 11) %}
            {% if i == 5 %}
                <option value=5 selected="selected">5</option> 
            {% else %}
                <option value={{ i }}>{{ i }}</option>
            {% endif %}
        {% endfor %}
    </select>
	<button id="search-button">Search</button>

    <form id="results"></form>
	<button id="submit" style="display:none">Submit</button>
	<br>
	<div id="chat-box" style="background-color:lightblue; transparency:40%; margin:auto; height:240px; width:400px;">
		<ul id="messages-list" style="overflow-y:auto; height:200px; width:370px; list-style-type: none;">
		</ul>
		<input id="message-box" style="align:center;" placeholder="Enter message">
		<button id="send-message" style="align:center;">Send</button>
	</div>

{% endblock %}
